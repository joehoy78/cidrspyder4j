package me.joehoy.pentest.modules;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.net.HttpURLConnection;
import java.net.URL;
import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;

import org.json.simple.JSONArray;
import org.json.simple.JSONObject;
import org.json.simple.parser.JSONParser;
import org.json.simple.parser.ParseException;

public class CustomSearch {
	
	public static JSONObject search(String key, String cx, String query) throws IOException, ParseException {
		String urlString = buildUrlString(key, cx, query);
		URL url = new URL(urlString);
		JSONParser parser = new JSONParser();
		return (JSONObject) parser.parse(UrlUtils.doGetRequest(url));
	}
	
	public static List<String> dork(String key, String cx, String fqdn) throws IOException, ParseException {
		List<String> linkList = new ArrayList<String>();
		String query = "site:" + fqdn;
		JSONObject results = search(key, cx, query);
		JSONArray items = (JSONArray) results.get("items");
		Iterator<String> iterator = items.iterator();
		while (iterator.hasNext()) {
			linkList.add(iterator.next());
		}
		return linkList;
	}	

	static String buildUrlString(String key, String cx, String query) {
		StringBuilder sb = new StringBuilder(256);
		sb.append("https://www.googleapis.com/customsearch/v1?");
		sb.append("cx=");
		sb.append(cx);
		sb.append("&key=");
		sb.append(key);
		sb.append("&query=");
		sb.append(query);
		return sb.toString();
	}
}
